# This action runs all common tooling for foundry repos
# It does not comment any results though.
# If you want to have comments on your repo, also install comment.yml
name: Test

concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

on:
  pull_request:
  push:
    branches: [main]

permissions:
  contents: write
  pull-requests: write

jobs:
  lint:
    uses: bgd-labs/github-workflows/.github/workflows/foundry-lint-prettier.yml@main
  build:
    name: Build
    runs-on: ubuntu-latest
    timeout-minutes: 120
    steps:
      - name: Checkout Repo
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install Foundry
        uses: foundry-rs/foundry-toolchain@v1
        with:
          version: stable

      - name: Cache Foundry
        uses: actions/cache@v4
        with:
          path: |
            ~/.foundry/cache
            cache
            out
          key: ${{ runner.os }}-foundry-${{ hashFiles('**/foundry.toml', '**/foundry.lock') }}
          restore-keys: |
            ${{ runner.os }}-foundry-

      - name: Build step 1 - Compile core contracts
        run: |
          echo "Step 1: Compiling core protocol contracts..."
          forge build --via-ir --skip test --skip script src/contracts/
        timeout-minutes: 60
        env:
          FOUNDRY_PROFILE: default
          FOUNDRY_DISABLE_NIGHTLY_WARNING: 1

      - name: Build step 2 - Compile deployment contracts
        run: |
          echo "Step 2: Compiling deployment contracts..."
          forge build --via-ir --skip test --skip script src/deployments/
        timeout-minutes: 30
        env:
          FOUNDRY_PROFILE: default
          FOUNDRY_DISABLE_NIGHTLY_WARNING: 1

      - name: Build step 3 - Compile scripts
        run: |
          echo "Step 3: Compiling scripts..."
          forge build --via-ir --skip test scripts/
        timeout-minutes: 20
        env:
          FOUNDRY_PROFILE: default
          FOUNDRY_DISABLE_NIGHTLY_WARNING: 1

  test:
    name: Test
    runs-on: ubuntu-latest
    timeout-minutes: 300
    needs: build
    steps:
      - name: Checkout Repo
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install Foundry
        uses: foundry-rs/foundry-toolchain@v1
        with:
          version: stable

      - name: Cache Foundry
        uses: actions/cache@v4
        with:
          path: |
            ~/.foundry/cache
            cache
            out
          key: ${{ runner.os }}-foundry-${{ hashFiles('**/foundry.toml', '**/foundry.lock') }}
          restore-keys: |
            ${{ runner.os }}-foundry-

      - name: Test step 1 - Deployment tests
        run: |
          echo "Step 1: Running deployment tests..."
          forge test tests/deployments/ --via-ir
        timeout-minutes: 30
        env:
          FOUNDRY_PROFILE: default
          FOUNDRY_DISABLE_NIGHTLY_WARNING: 1

      - name: Test step 2 - Protocol pool tests
        run: |
          echo "Step 2: Running protocol pool tests..."
          forge test tests/protocol/pool/ --via-ir
        timeout-minutes: 40
        env:
          FOUNDRY_PROFILE: default
          FOUNDRY_DISABLE_NIGHTLY_WARNING: 1

      - name: Test step 3 - Protocol tokenization tests
        run: |
          echo "Step 3: Running protocol tokenization tests..."
          forge test tests/protocol/tokenization/ --via-ir
        timeout-minutes: 30
        env:
          FOUNDRY_PROFILE: default
          FOUNDRY_DISABLE_NIGHTLY_WARNING: 1

      - name: Test step 4 - Protocol configuration tests
        run: |
          echo "Step 4: Running protocol configuration tests..."
          forge test tests/protocol/configuration/ --via-ir
        timeout-minutes: 15
        env:
          FOUNDRY_PROFILE: default
          FOUNDRY_DISABLE_NIGHTLY_WARNING: 1

      - name: Test step 5 - Protocol libraries tests
        run: |
          echo "Step 5: Running protocol libraries tests..."
          forge test tests/protocol/libraries/ --via-ir
        timeout-minutes: 15
        env:
          FOUNDRY_PROFILE: default
          FOUNDRY_DISABLE_NIGHTLY_WARNING: 1

      - name: Test step 6 - Rewards tests
        run: |
          echo "Step 6: Running rewards tests..."
          forge test tests/rewards/ --via-ir
        timeout-minutes: 20
        env:
          FOUNDRY_PROFILE: default
          FOUNDRY_DISABLE_NIGHTLY_WARNING: 1

      - name: Test step 7 - Misc tests
        run: |
          echo "Step 7: Running misc tests..."
          forge test tests/misc/ --via-ir
        timeout-minutes: 20
        env:
          FOUNDRY_PROFILE: default
          FOUNDRY_DISABLE_NIGHTLY_WARNING: 1

      - name: Test step 8 - Extensions paraswap tests
        run: |
          echo "Step 8: Running extensions paraswap tests..."
          forge test tests/extensions/paraswap-adapters/ --via-ir
        timeout-minutes: 15
        env:
          FOUNDRY_PROFILE: default
          FOUNDRY_DISABLE_NIGHTLY_WARNING: 1

      - name: Test step 9 - Extensions stata-token tests
        run: |
          echo "Step 9: Running extensions stata-token tests..."
          forge test tests/extensions/stata-token/ --via-ir
        timeout-minutes: 15
        env:
          FOUNDRY_PROFILE: default
          FOUNDRY_DISABLE_NIGHTLY_WARNING: 1

      - name: Test step 10 - Extensions v3-config-engine tests
        run: |
          echo "Step 10: Running extensions v3-config-engine tests..."
          forge test tests/extensions/v3-config-engine/ --via-ir
        timeout-minutes: 15
        env:
          FOUNDRY_PROFILE: default
          FOUNDRY_DISABLE_NIGHTLY_WARNING: 1

      - name: Test step 11 - Extensions other tests
        run: |
          echo "Step 11: Running extensions other tests..."
          forge test tests/extensions/ --via-ir --skip tests/extensions/paraswap-adapters/ --skip tests/extensions/stata-token/ --skip tests/extensions/v3-config-engine/
        timeout-minutes: 10
        env:
          FOUNDRY_PROFILE: default
          FOUNDRY_DISABLE_NIGHTLY_WARNING: 1
        continue-on-error: true

      - name: Test step 12 - Treasury tests
        run: |
          echo "Step 12: Running treasury tests..."
          forge test tests/treasury/ --via-ir
        timeout-minutes: 15
        env:
          FOUNDRY_PROFILE: default
          FOUNDRY_DISABLE_NIGHTLY_WARNING: 1

      - name: Test step 13 - Invariants tests
        run: |
          echo "Step 13: Running invariants tests..."
          forge test tests/invariants/ --via-ir
        timeout-minutes: 20
        env:
          FOUNDRY_PROFILE: default
          FOUNDRY_DISABLE_NIGHTLY_WARNING: 1

      - name: Test step 14 - Gas tests
        run: |
          echo "Step 14: Running gas tests..."
          forge test tests/gas/ --via-ir
        timeout-minutes: 15
        env:
          FOUNDRY_PROFILE: default
          FOUNDRY_DISABLE_NIGHTLY_WARNING: 1

      - name: Test step 15 - Helpers tests
        run: |
          echo "Step 15: Running helpers tests..."
          forge test tests/helpers/ --via-ir
        timeout-minutes: 15
        env:
          FOUNDRY_PROFILE: default
          FOUNDRY_DISABLE_NIGHTLY_WARNING: 1

      - name: Test step 16 - Harness tests
        run: |
          echo "Step 16: Running harness tests..."
          forge test tests/harness/ --via-ir || true
        timeout-minutes: 10
        env:
          FOUNDRY_PROFILE: default
          FOUNDRY_DISABLE_NIGHTLY_WARNING: 1
        continue-on-error: true

      - name: Test step 17 - Utils tests
        run: |
          echo "Step 17: Running utils tests..."
          forge test tests/utils/ --via-ir || true
        timeout-minutes: 10
        env:
          FOUNDRY_PROFILE: default
          FOUNDRY_DISABLE_NIGHTLY_WARNING: 1
        continue-on-error: true

      - name: Test step 18 - Template tests
        run: |
          echo "Step 18: Running template tests..."
          forge test tests/template/ --via-ir || true
        timeout-minutes: 10
        env:
          FOUNDRY_PROFILE: default
          FOUNDRY_DISABLE_NIGHTLY_WARNING: 1
        continue-on-error: true

      - name: Generate coverage report
        run: |
          mkdir -p lcov
          forge coverage --report lcov --via-ir || true
          if [ -f lcov.info ]; then
            mv lcov.info lcov/
          fi
        timeout-minutes: 30

      - name: Upload coverage artifact
        uses: actions/upload-artifact@v4
        with:
          name: lcov-report
          path: lcov/
          if-no-files-found: ignore
  codecov:
    needs: test
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repo
        uses: actions/checkout@v4

      - uses: actions/download-artifact@v4
        with:
          name: lcov-report
          path: lcov

      - name: Cleanup lcov
        run: |
          sudo apt-get -y install lcov
          lcov --remove ./lcov/lcov.info -o ./lcov/lcov.info \
          'src/contracts/helpers/UiIncentiveDataProviderV3.sol' \
          'src/contracts/helpers/UiPoolDataProviderV3.sol' \
          'src/contracts/helpers/WalletBalanceProvider.sol' \
          'src/contracts/dependencies/*'

      - name: Upload coverage reports to Codecov
        uses: codecov/codecov-action@ea99328d1c4d5f39fda7cbffe104afd6906c50b0
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          slug: ${{ github.repository }}
          files: ./lcov/lcov.info
# only when the repo has zksync code
#  test-zk:
#    uses: bgd-labs/github-workflows/.github/workflows/foundry-test-zk.yml@main
